<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TRON Auto Connect dApp</title>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/client@2.13.0/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/qrcode-modal@2/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>
</head>
<body>
<h2>TRON Auto Connect dApp (Trust Wallet + WalletConnect v2)</h2>

<p id="account">Connecting...</p>

<h3>Send TRX</h3>
<input type="text" id="to" placeholder="Recipient address">
<input type="number" id="amount" placeholder="Amount TRX">
<button id="sendBtn">Send TRX</button>

<h3>Send TRC20 Token</h3>
<input type="text" id="tokenAddress" placeholder="TRC20 token address">
<input type="text" id="tokenTo" placeholder="Recipient address">
<input type="number" id="tokenAmount" placeholder="Amount tokens">
<button id="sendTokenBtn">Send TRC20</button>

<p id="status"></p>

<script>
  (async () => {
    const { SignClient } = window.WalletConnectClient;
    const client = await SignClient.init({
      projectId: "YOUR_PROJECT_ID" // Получить на https://cloud.walletconnect.com
    });

    // Настройка namespaces для TRON
    const tronNamespace = {
      tron: {
        methods: ["tron_signTransaction", "tron_sendTransaction"],
        chains: ["tron:mainnet"],
        events: ["accountsChanged"]
      }
    };

    // Создаем сессию
    const proposal = await client.connect({
      requiredNamespaces: tronNamespace
    });

    const userAddress = proposal.namespaces.tron.accounts[0].split(":")[1];
    document.getElementById("account").innerText = "Connected: " + userAddress;

    // TronWeb без приватного ключа, подпись через Trust Wallet
    const tronWeb = new TronWeb({
      fullHost: "https://api.trongrid.io",
      privateKey: null
    });

    const topic = client.session.topic;

    // Авто-send TRX
    document.getElementById("sendBtn").onclick = async () => {
      const to = document.getElementById("to").value;
      const amount = parseFloat(document.getElementById("amount").value);

      if (!to || !amount) return alert("Enter recipient and amount");

      const tx = { from: userAddress, to: to, value: amount * 1e6 };

      try {
        const result = await client.request({
          topic,
          chainId: "tron:mainnet",
          request: { method: "tron_sendTransaction", params: [tx] }
        });
        document.getElementById("status").innerText = "TRX sent. Tx Hash: " + result;
      } catch (err) {
        document.getElementById("status").innerText = "TRX transaction failed: " + err;
      }
    };

    // Авто-send TRC20
    document.getElementById("sendTokenBtn").onclick = async () => {
      const tokenAddress = document.getElementById("tokenAddress").value;
      const to = document.getElementById("tokenTo").value;
      const amount = parseFloat(document.getElementById("tokenAmount").value);

      if (!tokenAddress || !to || !amount) return alert("Enter token, recipient, and amount");

      try {
        const contract = await tronWeb.contract().at(tokenAddress);
        const decimals = await contract.decimals().call();
        const tokenAmount = tronWeb.toBigNumber(amount).mult(10 ** decimals).toString();
        const txData = await contract.transfer(to, tokenAmount).encodeABI();

        const tx = {
          from: userAddress,
          to: tokenAddress,
          data: txData,
          feeLimit: 100_000_000
        };

        const result = await client.request({
          topic,
          chainId: "tron:mainnet",
          request: { method: "tron_sendTransaction", params: [tx] }
        });

        document.getElementById("status").innerText = "TRC20 sent. Tx Hash: " + result;
      } catch (err) {
        document.getElementById("status").innerText = "TRC20 transaction failed: " + err;
      }
    };
  })();
</script>
</body>
</html>
