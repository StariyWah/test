<!DOCTYPE html>
<html>
<head>
    <title>TRON Balance - Trust Wallet</title>
    <!-- –¢–æ–ª—å–∫–æ TronWeb –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–µ—Ç—å—é TRON -->
    <script src="https://unpkg.com/tronweb@4.3.0/dist/TronWeb.js"></script>
</head>
<body>
    <div style="padding: 20px; font-family: Arial, sans-serif;">
        <h2>TRON Balance Checker</h2>
        
        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
        <div id="mobileInstructions" style="display: none; background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3>üì± Mobile Instructions:</h3>
            <p><strong>Step 1:</strong> Open Trust Wallet</p>
            <p><strong>Step 2:</strong> Tap on <strong>"Browser"</strong> at the bottom</p>
            <p><strong>Step 3:</strong> Enter this URL in browser: <code id="currentUrl"></code></p>
            <p><strong>Step 4:</strong> Click "Connect" button below</p>
        </div>

        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ -->
        <div id="desktopInstructions" style="display: none; background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3>üíª Desktop Instructions:</h3>
            <p>Trust Wallet mobile only. Open this page on your phone.</p>
            <p>Or scan QR code to open on mobile:</p>
            <div id="qrCode"></div>
        </div>

        <button id="connectBtn" onclick="connectWallet()" style="padding: 12px 24px; font-size: 16px; background: #3375bb; color: white; border: none; border-radius: 6px; cursor: pointer;">
            Connect Trust Wallet
        </button>

        <div id="balanceDiv" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
            <h3>üí∞ Your TRON Balance</h3>
            <div style="font-size: 24px; font-weight: bold; color: #3375bb;">
                <span id="balanceAmount">0</span> TRX
            </div>
            <div style="margin-top: 10px; font-family: monospace; background: white; padding: 10px; border-radius: 4px; word-break: break-all;">
                Address: <span id="accountAddress"></span>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="refreshBalance()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                    Refresh Balance
                </button>
                <button onclick="disconnectWallet()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Disconnect
                </button>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∞) -->
        <div id="manualInput" style="display: none; margin-top: 20px; padding: 20px; background: #fff8e1; border-radius: 8px;">
            <h3>Alternative: Manual Private Key Input</h3>
            <p><small>‚ö†Ô∏è For testing only. Never enter your main wallet private key!</small></p>
            <input type="text" id="privateKey" placeholder="Enter test private key" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
            <button onclick="connectWithPrivateKey()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Connect with Private Key
            </button>
        </div>
    </div>

    <script>
        let tronWeb = null;
        let connectedAddress = null;
        let wallet = null; // –î–ª—è Trust Wallet –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        document.getElementById('currentUrl').textContent = window.location.href;
        
        if (isMobile) {
            document.getElementById('mobileInstructions').style.display = 'block';
            document.getElementById('manualInput').style.display = 'block';
        } else {
            document.getElementById('desktopInstructions').style.display = 'block';
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(window.location.href)}`;
            document.getElementById('qrCode').innerHTML = `<img src="${qrUrl}" alt="Scan QR code" style="border: 1px solid #ccc;">`;
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        async function connectWallet() {
            const btn = document.getElementById('connectBtn');
            btn.disabled = true;
            btn.textContent = 'Connecting...';
            
            try {
                console.log('Trying to connect to Trust Wallet...');
                
                // –°–ø–æ—Å–æ–± 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ Trust Wallet
                if (typeof window.trustwallet !== 'undefined') {
                    console.log('Trust Wallet provider found');
                    wallet = window.trustwallet;
                    await handleTrustWalletProvider();
                    return;
                }
                
                // –°–ø–æ—Å–æ–± 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ window.ethereum (Web3 –ø—Ä–æ–≤–∞–π–¥–µ—Ä)
                if (typeof window.ethereum !== 'undefined') {
                    console.log('Ethereum provider found, trying for TRON...');
                    await handleEthereumProvider();
                    return;
                }
                
                // –°–ø–æ—Å–æ–± 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º window.web3 (—Å—Ç–∞—Ä—ã–π —Å—Ç–∏–ª—å)
                if (typeof window.web3 !== 'undefined') {
                    console.log('Web3 provider found');
                    await handleWeb3Provider();
                    return;
                }
                
                // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                throw new Error('No wallet provider detected');
                
            } catch (error) {
                console.error('Connection error:', error);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
                if (isMobile) {
                    alert('Trust Wallet not detected.\n\nPlease ensure:\n1. You are in Trust Wallet app\n2. You are in the "Browser" tab\n3. URL is exactly: ' + window.location.href + '\n\nThen refresh and try again.');
                } else {
                    alert('Trust Wallet is mobile-only.\n\nPlease:\n1. Open Trust Wallet on your phone\n2. Go to Browser tab\n3. Enter this URL: ' + window.location.href + '\n4. Try connecting again');
                }
                
                btn.disabled = false;
                btn.textContent = 'Connect Trust Wallet';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Trust Wallet –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        async function handleTrustWalletProvider() {
            try {
                // Trust Wallet –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Ethereum-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                const accounts = await wallet.request({ method: 'eth_requestAccounts' });
                
                if (accounts && accounts.length > 0) {
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Ethereum –∞–¥—Ä–µ—Å –≤ TRON
                    const ethAddress = accounts[0];
                    connectedAddress = convertToTronAddress(ethAddress);
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º TronWeb –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–µ—Ç—å—é TRON
                    await initTronWeb();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å
                    await showBalance();
                    updateUI(true);
                    
                    console.log('Connected to Trust Wallet:', connectedAddress);
                }
            } catch (error) {
                console.error('Trust Wallet connection error:', error);
                throw error;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Ethereum –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        async function handleEthereumProvider() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                if (accounts && accounts.length > 0) {
                    const ethAddress = accounts[0];
                    connectedAddress = convertToTronAddress(ethAddress);
                    await initTronWeb();
                    await showBalance();
                    updateUI(true);
                }
            } catch (error) {
                console.error('Ethereum provider error:', error);
                throw error;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Web3 –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        async function handleWeb3Provider() {
            try {
                const accounts = await window.web3.eth.getAccounts();
                if (accounts && accounts.length > 0) {
                    const ethAddress = accounts[0];
                    connectedAddress = convertToTronAddress(ethAddress);
                    await initTronWeb();
                    await showBalance();
                    updateUI(true);
                }
            } catch (error) {
                console.error('Web3 provider error:', error);
                throw error;
            }
        }

        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Ethereum –∞–¥—Ä–µ—Å–∞ –≤ TRON –∞–¥—Ä–µ—Å
        function convertToTronAddress(ethAddress) {
            if (!ethAddress) return null;
            
            let address = ethAddress.toLowerCase();
            if (address.startsWith('0x')) {
                address = address.substring(2);
            }
            
            // TRON –∞–¥—Ä–µ—Å–∞ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å '41' (hex) –∏–ª–∏ 'T' (base58)
            // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ–±—É–µ–º base58, –µ—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å T
            if (ethAddress.startsWith('T') && ethAddress.length === 34) {
                return ethAddress; // –£–∂–µ TRON –∞–¥—Ä–µ—Å –≤ base58
            }
            
            // –ò–Ω–∞—á–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏–∑ hex (Ethereum) –≤ TRON
            if (address.length === 40) { // –ë–µ–∑ 0x
                // TRON hex –∞–¥—Ä–µ—Å–∞ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 41
                const tronHex = '41' + address;
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º hex –≤ base58 (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
                // –ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
                return tronHex; // –í—Ä–µ–º–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º hex
            }
            
            return ethAddress; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TronWeb
        async function initTronWeb() {
            try {
                const fullNode = 'https://api.trongrid.io';
                const solidityNode = 'https://api.trongrid.io';
                const eventServer = 'https://api.trongrid.io';
                
                tronWeb = new TronWeb(fullNode, solidityNode, eventServer);
                
                // –ï—Å–ª–∏ –∞–¥—Ä–µ—Å –≤ —Ñ–æ—Ä–º–∞—Ç–µ base58 (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å T)
                if (connectedAddress && connectedAddress.startsWith('T')) {
                    tronWeb.setAddress(connectedAddress);
                }
                
                console.log('TronWeb initialized');
            } catch (error) {
                console.error('TronWeb init error:', error);
                throw error;
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å
        async function showBalance() {
            if (!connectedAddress) {
                alert('Not connected');
                return;
            }
            
            try {
                let balanceSun;
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å TronWeb –∏ –∞–¥—Ä–µ—Å –≤ base58
                if (tronWeb && connectedAddress.startsWith('T')) {
                    balanceSun = await tronWeb.trx.getBalance(connectedAddress);
                } else {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π API –∑–∞–ø—Ä–æ—Å
                    const response = await fetch('https://api.trongrid.io/v1/accounts/' + connectedAddress);
                    const data = await response.json();
                    
                    if (data.data && data.data.length > 0) {
                        balanceSun = data.data[0].balance || 0;
                    } else {
                        balanceSun = 0;
                    }
                }
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º SUN –≤ TRX
                const balanceTRX = balanceSun / 1000000;
                const formattedBalance = balanceTRX.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 6
                });
                
                document.getElementById('balanceAmount').textContent = formattedBalance;
                document.getElementById('accountAddress').textContent = connectedAddress;
                
                console.log('Balance:', formattedBalance, 'TRX');
                
            } catch (error) {
                console.error('Balance error:', error);
                alert('Failed to get balance. Error: ' + error.message);
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
        async function refreshBalance() {
            await showBalance();
        }

        // –û–±–Ω–æ–≤–∏—Ç—å UI
        function updateUI(isConnected) {
            const btn = document.getElementById('connectBtn');
            const balanceDiv = document.getElementById('balanceDiv');
            
            if (isConnected) {
                btn.style.display = 'none';
                balanceDiv.style.display = 'block';
                document.getElementById('mobileInstructions').style.display = 'none';
                document.getElementById('desktopInstructions').style.display = 'none';
            } else {
                btn.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'Connect Trust Wallet';
                balanceDiv.style.display = 'none';
            }
        }

        // –û—Ç–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫
        function disconnectWallet() {
            tronWeb = null;
            connectedAddress = null;
            wallet = null;
            updateUI(false);
            console.log('Disconnected');
        }

        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (–¢–û–õ–¨–ö–û –î–õ–Ø –¢–ï–°–¢–ê!)
        async function connectWithPrivateKey() {
            const privateKey = document.getElementById('privateKey').value.trim();
            
            if (!privateKey) {
                alert('Please enter a private key');
                return;
            }
            
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º TronWeb —Å –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –∫–ª—é—á–æ–º
                const fullNode = 'https://api.trongrid.io';
                const solidityNode = 'https://api.trongrid.io';
                const eventServer = 'https://api.trongrid.io';
                
                tronWeb = new TronWeb(fullNode, solidityNode, eventServer, privateKey);
                
                // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –∏–∑ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
                connectedAddress = tronWeb.defaultAddress.base58;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å
                await showBalance();
                updateUI(true);
                
                console.log('Connected with private key:', connectedAddress);
                
                // –û–ß–ï–ù–¨ –í–ê–ñ–ù–û: –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ —Å –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –∫–ª—é—á–æ–º
                document.getElementById('privateKey').value = '';
                
            } catch (error) {
                console.error('Private key connection error:', error);
                alert('Invalid private key or connection error');
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            console.log('Page loaded. Checking for wallet providers...');
            console.log('window.trustwallet:', typeof window.trustwallet);
            console.log('window.ethereum:', typeof window.ethereum);
            console.log('window.web3:', typeof window.web3);
            console.log('window.tronWeb:', typeof window.tronWeb);
            console.log('window.tronLink:', typeof window.tronLink);
            
            // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            if (typeof window.trustwallet !== 'undefined' || 
                typeof window.ethereum !== 'undefined' || 
                typeof window.web3 !== 'undefined') {
                console.log('Wallet provider detected on page load');
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è - –∂–¥–µ–º –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            }
        });
    </script>
</body>
</html>
