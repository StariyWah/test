<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TRON WalletConnect dApp</title>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/client@1.7.8/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.js"></script>
</head>
<body>
  <h2>TRON dApp (Trust Wallet + WalletConnect)</h2>

  <button id="connectBtn">Connect Wallet</button>
  <p id="account">Not connected</p>

  <input type="text" id="to" placeholder="Recipient address">
  <input type="number" id="amount" placeholder="Amount TRX">
  <button id="sendBtn">Send TRX</button>

  <p id="status"></p>

  <script>
    let connector;
    let userAddress;

    // Подключение кошелька
    document.getElementById("connectBtn").onclick = async () => {
      connector = new WalletConnect.default({
        bridge: "https://bridge.walletconnect.org",
        qrcodeModal: null // отключаем QR
      });

      if (!connector.connected) {
        await connector.createSession();
      }

      // Deep link для Trust Wallet
      const uri = connector.uri;
      const trustLink = `trust://wc?uri=${encodeURIComponent(uri)}`;
      window.open(trustLink, "_blank");

      connector.on("connect", (error, payload) => {
        if (error) throw error;
        const { accounts } = payload.params[0];
        userAddress = accounts[0];
        document.getElementById("account").innerText = "Connected: " + userAddress;
        document.getElementById("status").innerText = "Wallet connected!";
      });

      connector.on("disconnect", (error, payload) => {
        if (error) throw error;
        userAddress = null;
        document.getElementById("account").innerText = "Not connected";
        document.getElementById("status").innerText = "Wallet disconnected";
      });
    };

    // Отправка TRX
    document.getElementById("sendBtn").onclick = async () => {
      if (!connector || !userAddress) {
        alert("Connect wallet first");
        return;
      }

      const to = document.getElementById("to").value;
      const amount = parseFloat(document.getElementById("amount").value);

      if (!to || !amount) {
        alert("Enter recipient and amount");
        return;
      }

      const tx = {
        from: userAddress,
        to: to,
        value: amount * 1e6 // TRX → Sun
      };

      try {
        const txHash = await connector.sendTransaction(tx);
        document.getElementById("status").innerText = "Transaction Hash: " + txHash;
      } catch (err) {
        document.getElementById("status").innerText = "Transaction failed: " + err;
      }
    };
  </script>
</body>
</html>
