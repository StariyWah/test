<!DOCTYPE html>
<html>
<head>
    <title>TRON Balance</title>
    <script src="https://unpkg.com/tronweb@4.3.0/dist/TronWeb.js"></script>
</head>
<body>
    <button id="connectBtn" onclick="connectTronLink()">Connect Trust Wallet</button>
    <div id="balanceDiv" style="display: none;">
        <div>Balance: <span id="balanceAmount">0</span> TRX</div>
        <div>Address: <span id="accountAddress"></span></div>
        <button onclick="disconnectWallet()">Disconnect</button>
    </div>

    <script>
        let tronWeb = null;
        let connectedAddress = null;

        async function connectTronLink() {
            const btn = document.getElementById('connectBtn');
            btn.disabled = true;
            btn.textContent = 'Connecting...';
            
            try {
                // Проверяем, установлен ли TronLink/Trust Wallet
                if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
                    // Используем существующее подключение
                    tronWeb = window.tronWeb;
                    connectedAddress = tronWeb.defaultAddress.base58;
                    await updateBalance();
                    updateUI(true);
                    return;
                }

                // Если кошелек не обнаружен
                if (isMobileDevice()) {
                    // На мобильном - открываем Trust Wallet
                    window.location.href = 'https://link.trustwallet.com/open_url?coin_id=195&url=' + encodeURIComponent(window.location.href);
                    setTimeout(() => {
                        alert('Please open this page in Trust Wallet browser');
                    }, 1000);
                } else {
                    // На десктопе - предлагаем установить TronLink
                    if (confirm('Trust Wallet/TronLink not detected. Install extension?')) {
                        window.open('https://chrome.google.com/webstore/detail/tronlink/ibnejdfjmmkpcnlpebklmnkoeoihofec', '_blank');
                    }
                }

            } catch (error) {
                console.error('Connection error:', error);
                alert('Connection failed: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Connect Trust Wallet';
            }
        }

        async function updateBalance() {
            if (!tronWeb || !connectedAddress) {
                alert('Not connected');
                return;
            }
            
            try {
                const balanceSun = await tronWeb.trx.getBalance(connectedAddress);
                const balanceTRX = tronWeb.fromSun(balanceSun);
                const formattedBalance = parseFloat(balanceTRX).toFixed(6);
                
                document.getElementById('balanceAmount').textContent = formattedBalance;
                document.getElementById('accountAddress').textContent = connectedAddress;
                
                console.log('Balance:', formattedBalance, 'TRX');
            } catch (error) {
                console.error('Balance error:', error);
                alert('Failed to get balance: ' + error.message);
            }
        }

        function updateUI(isConnected) {
            const btn = document.getElementById('connectBtn');
            const balanceDiv = document.getElementById('balanceDiv');
            
            if (isConnected) {
                btn.style.display = 'none';
                balanceDiv.style.display = 'block';
            } else {
                btn.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'Connect Trust Wallet';
                balanceDiv.style.display = 'none';
            }
        }

        function disconnectWallet() {
            tronWeb = null;
            connectedAddress = null;
            updateUI(false);
            console.log('Disconnected');
        }

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Проверяем кошелек при загрузке
        window.addEventListener('load', () => {
            // Периодически проверяем наличие кошелька
            const checkWallet = setInterval(() => {
                if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
                    tronWeb = window.tronWeb;
                    connectedAddress = tronWeb.defaultAddress.base58;
                    updateBalance();
                    updateUI(true);
                    clearInterval(checkWallet);
                }
            }, 1000);
        });
    </script>
</body>
</html>
